# Admixture_scripts
scripts to convert to ped format from vcf and quality of life script to run admixture

You need a filtered vcf file to do the conversion and download plink from here: https://www.cog-genomics.org/plink2 (version 1.9 stable). Then make a symbolic link for plink to the environment path (sudo ln -s /path/to/plink /usr/local/bin , make sure that the paths are absolute and not relative!) and make sure that plink has executive rights (sudo chmod +x /path/to/plink). The conversion script is run using python3. to run it type in the terminal: python3 /path/to/convertVcf2.py -i /path/to/myOrganism.vcf -o /path/to/myOrganism
Note that there should be no ending on the output file (-o).

To use the admixture script, it is required to have admixture in the environment path, download from: http://software.genetics.ucla.edu/admixture/download.html and create symbolic link like above (and set the executive rights). Then use the script like this: /path/to/admixture.sh myOrganism.ped outputfolderName maxK NrThreads (example: /path/to/admixture.sh onosma.ped onosma_admixture 10 12). First is name or path to your ped file, second is the name of the folder where it will output the results and the third is the number of threads to use and the last is the max nr of K to which to analyze.

Before we try and plot the results, we need to sort it by admixture ratios in order to get an easily readable plot. First you need to open a spreadsheet and copy the content of your popmap (same as used when running stacks) into the first two columns, then copy the individual names in the first column into the third column, this will be used as part of the group map later. Now copy the content of the best K Q file (mine is called spic28.4.Q) into the columns following the first three. At first this Q file will just look like a mess of numbers, but there is a simply structure involved. 

Each column in the Q file is the ratio of "belonging" or "relatedness" of each individual to a specific structure (group/region etc). We call that the admixture ratio. The sum of all admixture ratios for one individual (one row) should always be 1, it might be slightly less or higher due to rounding of long decimal numbers. This means that the first column in the first row is the admixture ratio of individual 1 to structure 1, how much of the first individuals genome comes from the first structure modeled in admixture. Note that this isn't absolute or 100% correct, this is just the ratio modeled under the specific K and shows if anything the admixture of different major structures within the individuals, a simplification that is not accurate on a detailed level, but likely highly informative on a larger scale.

So in order make your structure plot look a bit more intuitive you can either manually cut and paste rows in your spreadsheet to move individuals and populations until those that belong together in a structure are next to each other or you can sort admixture ratios using the built-in spreadsheet function. The latter method can be a bit tricky if there are more than 2 structures (K>2). A trick to make this easier is to first sort the first column (structure) in a descending order, then where that structure reaches roughly 50%, you introduce a new empty row. This allows you to sort the two separate parts independently. First sort the first (upper) part by the population name (second column) this will make sure that all individuals that are in the same population are together. Next, sort the second half of the list of admixture ratios, then repeat the previous when it reaches 50% until you have sorted all structures (columns), as well as the population names within each section.

Once you have finished sorting your data, introduce a new column in between the third column (the column with the copy of list of individual names) and the fourth column (the first admixture ratio). You should now have a sheet that is divided row-wise by the number structure you have (the same number as you have structure columns), these are you structures, and column-wise by an empty fourth column.

In the fourth column you have to enter a name for each structure, either the region where they are found or the cardinal direction of the structure in the distribution of your species, or some other relevant name. The easiest way to give a group name to all individuals within a structure, is to write the name of the structure into the first row cell for said structure (section divided by an empty row) in the new empty fourth column. Then copy that cell (not the name within the cell, just mark the cell and copy it) and mark all empty cells in the fourth column for the structure then paste into the marked cells. This should copy the name into all empty cells of the structure. Continue to do the same for the other structures. Once all individuals have been assigned to a group, remove the empty rows between the structures. Make sure that the first row starts with the entry of the first individual and not a title for the column (a header such as ‘individual’ or ‘population’). No header/title is allowed in the final file. Now save the spreadsheet as a csv file (in Libreoffice Calc: File>Save as… then write a name ( admix_sorted for example) and in the lower right corner, click the drop down menu ‘all formats’ and scroll down and click ‘text CSV (.csv)’, then click save in the upper right corner). If you get prompted about settings for the csv file, choose to have delimiter be a comma (,) string delimiter doesn't matter much.

Now open the R script plot_admixture3.R in Rstudio. You will need to edit the line: setwd("/path/to/folder/") , by replacing /path/to/folder/ within the quotation marks with the full path to the folder where your csv file is at. This will also be your output folder. Then replace: admix_sorted.csv in the line inputfile.name = "admix_sorted.csv" to whatever you named your file. Then run all the lines of the script. It will create both a pdf and a png image of your plot.


The R script piechartMap.R plots the average admixture ratios for each population in pie charts on a map, given coordinates. Calculate average admixture ratio for each population and put this in a .csv file with coordinates (use pieplot_K4.csv as an example of how to set it up), where CoordLat and CoordLong are the actual coordinates of the population, and plotLat and plotLong are the coordinates where you want the piechart to be plotted. The Columns: nr, group and pop are not used, they are only to aid in orientation.
